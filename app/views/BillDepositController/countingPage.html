#{extends 'main.html' /}
#{set title:'Doing transaction..' /}
<div class="row">
    <div class="span11 well">
        <table class="table table-bordered table-striped" >
            <thead>
                <tr>
                    #{list items:billData, as:'b'}
                    <th>
                        ${b.billType}
                    </th>
                    #{/list}
                </tr>
            </thead>
            <tbody>
                <tr>
                    #{list items:billData, as:'b'}
                    <td id="BID_${b.billType.billTypeId}">
                        ${b.quantity}
                    </td>
                    #{/list}
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="span3">
        #{ifAuthorized resource: 'BillDepositController.acceptBatch', operation: 'GET'}
        <div class="control-group">
            <div class="controls">
                <a class="btn btn-primary btn-large menu-button-fixed-size-btn" href="@{ BillDepositController.acceptBatch(deposit.depositId) }">Accept Batch</a>
            </div>
        </div>        
        #{/ifAuthorized}
        #{ifAuthorized resource: 'BillDepositController.cancelDeposit', operation: 'GET'}
        <div class="control-group">
            <div class="controls">
                <a class="btn btn-primary btn-large menu-button-fixed-size-btn" href="@{ BillDepositController.cancelDeposit(deposit.depositId) }">Cancel Deposit</a>
            </div>
        </div>
        #{/ifAuthorized}
    </div>
</div>

#{set 'moreScripts'}
<script type="text/javascript" charset="${_response_encoding}">
    var waiting = false;
    
    // Reload the whole messages panel
    function refresh() {
        if ( waiting ) {
            return;
        }
        waiting = true;
        $.getJSON( '@{BillDepositController.getCountersAndStatus}', function( data ) {
            waiting = false;
            var success = data[ 0 ];
            if ( success == null || success.toString() == 'null' ) {
                $('#success').hide();
            } else {
                $('#success').show();                
                $('#success_msg').html( success )
            }
            var billData = data[ 1 ]
            for( var i = 0 ; i < billData.length; i ++ ) {
                var nid = '#BID_' + billData[ i ].billType.billTypeId.toString();
                $( nid ).html( billData[ i ].quantity);
            }
            for( var i = 0 ; i < billData.length; i ++ ) {
                var nid = '#DID_' + billData[ i ].billType.billTypeId.toString();
                $( nid ).html( billData[ i ].desiredQuantity);
            }
        })
    }
    // Call refresh every .5 seconds
    setInterval(refresh, 1000)
    refresh()
</script>
#{/set}
