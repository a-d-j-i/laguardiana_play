#{extends 'main.html' /}
#{set title:'Doing transaction..' /}


<div id="dialog-modal" title="Basic modal dialog">
    <p>Adding the modal overlay screen makes the dialog look more prominent because it dims out the page content.</p>
</div>


<section id="depositar_efectivo_02">
    <header></header>
    <!-- link volver -->
    <a href="@{BillDepositController.cancelDeposit()}" class="boton_top">â—„ &{ 'application.back' }</a>
    <!-- /link volver -->
    #{form @acceptBatch(depositId), 'id' : 'continueForm' }
    <input type="hidden" name="depositId" value="${depositId}">
    #{/form}
    <article>
        <h1 class="depositar_efectivo">&{ 'main_menu.cash_deposit' }</h1>
        <ul class="columns">
            <li class="fixed column" style="width: 45%">
                <div class="columna_1">
                    <!-- resumen de datos -->
                    <p>&{ 'counting_page.currency_title' }: ${currency}</p>
                    <p>&{ 'counting_page.reference1_title' }: ${userCode}</p>
                    <p>&{ 'counting_page.reference2_title' }: ${userCodeLov}</p>
                    <p>&{ 'counting_page.client_code_title' }: ${clientCode}</p>
                    <!-- /resumen de datos -->
                </div>
            </li>
            <li class="fixed column" style="width: 55%">
                <table class="full_width">
                    <thead>
                        <tr>
                            <th>&{ 'counting_page.denomination' }</th>
                            <th>&{ 'counting_page.quantity' }</th>
                            <th>&{ 'counting_page.total' }</th>
                        </tr>
                    </thead>

                    <tbody>
                        <!-- detalle de billetes -->
                        %{ total = 0; cnt_total = 0;}%
                        #{list items:billData, as:'b'}
                        <tr id="BTRID_${b.billTypeId}">
                            <td id="bill_denomination">${b.denomination}</td>
                            <td id="bill_quantity">${b.quantity}</td>
                            <td id="bill_total">${b.denomination  * b.quantity}</td>
                            %{ total += b.denomination  * b.quantity; cnt_total += b.quantity }%
                        </tr>
                        #{/list}
                        <!-- /detalle de billetes -->
                    </tbody>

                    <tfoot>
                        <tr>
                            <td>&{ 'counting_page.totals' }</td>
                            <!-- totales -->
                            <td id ="cnt_total">${ cnt_total }</td>
                            <td id ="total">${ total }</td>
                            <!-- /totales -->
                        </tr>
                    </tfoot>
                </table>
            </li>
        </ul>
        <div class="botonera">
            <ul class="columns">
                <li class="fixed column" style="width: 50%">
                    <!-- link cancelar -->
                    <a href="@{BillDepositController.cancelDeposit(depositId)}" class="boton rojo">&{ 'application.cancel' }</a>
                    <!-- /link cancelar -->
                </li>
                <li class="fixed column" style="width: 50%">
                    <div class="columna_2">
                        <!-- link continuar -->
                        <a id ="continueButton" href="#" class="boton gris">&{ 'application.continue' }</a>
                        <!-- /link continuar -->
                    </div>
                </li>
            </ul>
        </div>
    </article>
</section>

#{set 'moreScripts'}
<script type="text/javascript" charset="${_response_encoding}">
    var waiting = false;
    
    // Reload the whole messages panel
    function refresh() {
        if ( waiting ) {
            return;
        }
        waiting = true;
        $.getJSON( '@{BillDepositController.countingPage}', function( data ) {
            waiting = false;
            var status = data[ 0 ];
            var billData = data[ 1 ];
            if ( status != null && status.toString() != 'null' ) {
                if ( status == 'IDLE' ) {
                } else if ( status == 'INITIALIZING' ) {
                } else if ( status == 'PUT_THE_BILLS_ON_THE_HOPER' ) {
                    alert( status );
                } else if ( status == 'READY_TO_STORE' ) {
                    $( '#continueButton' ).attr( { 'class' : 'boton naranja'});
                    $( '#continueButton' ).click( function(event) {
                        $( '#continueForm').submit();
                    });
                } else {
                    alert( status );
                }
            }
            var total = 0;
            var cnt_total = 0;
            for( var i = 0 ; i < billData.length; i ++ ) {
                var nid = '#BTRID_' + billData[ i ].billTypeId;
                $( nid ).children( '#bill_denomination' ).html( billData[ i ].denomination );
                $( nid ).children( '#bill_quantity' ).html( billData[ i ].quantity );
                var t = ( billData[ i ].denomination * billData[ i ].quantity );
                $( nid ).children( '#bill_total' ).html( t );
                total += t;
                cnt_total += billData[ i ].quantity;
            }
            $( '#cnt_total' ).html( cnt_total );
            $( '#total' ).html( total );
        })
    }
    $( '#continueButton' ).click( function(event) {
        event.preventDefault();
    });
    // Call refresh every 1.5 seconds
    setInterval(refresh, 1500);
    refresh();
</script>


<script type="text/javascript" charset="${_response_encoding}">
    var waitingCancelationRequest = false;
    var waitingCancelationInterval = null;

    var waitAcceptanceRequest = false;
    var waitAcceptanceInterval = null;

    function setup() {
        $(".controls-after-batch").hide();
        $("#cancelBatch").click(function(){
            $.getJSON( '@{BillDepositController.cancelDeposit(deposit.depositId)}}', 
            function( data ) {
                var success = data [ 0 ];
                if (success == 1) {
                    //we should wait for cancellation finish..
                    waitingCancelationInterval = setInterval(waitCancelation, 700)
                } else {
                    alert ("cancel batch order failed.. perhaps we should retry");
                }
            })
        });
        
        $("#acceptBatch").click(function(){
            $.getJSON( '@{BillDepositController.acceptBatch(deposit.depositId)}', 
            function( data ) {
                var success = data [ 0 ];
                if (success == 1) {
                    //we should wait for cancellation finish..
                    waitAcceptanceInterval = setInterval(waitAcceptance, 700)
                } else {
                    alert ("accept batch order failed.. perhaps we should retry");
                }
            })
        });

        $("#continueBatch").click(function() {
            $(".controls-after-batch").hide();
            $(".controls-pre-batch").show();
            $.getJSON( '@{BillDepositController.countingPage(deposit.depositId)}', 
            function( data ) { 
                if (data[0]) {
                    //pass everything is ok
                } else {
                    //count command was not accepted.. going to main
                    window.location = '@{Application.index}'}
            }
                        
        );  
            //window.location = ;
        });

        $("#finishDeposit").click(function() {
            $.getJSON( '@{BillDepositController.finishDeposit(deposit.depositId)}', 
            function( data ) { window.location = '@{Application.index}'}
        );  
        });
    }

    function waitCancelation() {
        if (waitingCancelationRequest) {
            return;
        }
        waitingCancelationRequest = true;
        $.getJSON( '@{BillDepositController.checkCancelDeposit(deposit.depositId)}', 
        function( data ) {
            waitingCancelationRequest = false;
            var finishedOp = data[0];
            var resultOk = data[1];
            if (finishedOp) {
                clearInterval(waitingCancelationInterval);
                if (resultOk) {
                    window.location = '@{Application.index}'
                } else {
                    alert("XXX: cancelation failed!")
                }
            }
        })
    }

    function waitAcceptance() {
        if (waitAcceptanceRequest) {
            return;
        }
        waitAcceptanceRequest = true;
        $(".controls-pre-batch").hide();
        $.getJSON( '@{BillDepositController.checkAcceptBatch(deposit.depositId)}', 
        function( data ) {
            waitAcceptanceRequest = false;
            var finishedOp = data[0];
            var resultOk = data[1];
            if (finishedOp) {
                clearInterval(waitAcceptanceInterval);
                if (resultOk) {
                    $(".controls-pre-batch").hide();
                    $(".controls-after-batch").show();
                } else {
                    alert("XXX: acceptance failed!")
                }
            }
        })
    }
    
    setup()
</script>


<script>
    $(function() {
        // a workaround for a flaw in the demo system (http://dev.jqueryui.com/ticket/4375), ignore!
        $( "#dialog:ui-dialog" ).dialog( "destroy" );
	
        $( "#dialog-modal" ).dialog({
            height: 140,
            modal: true,
            autoOpen: false
        });
    });
</script>




#{/set}
