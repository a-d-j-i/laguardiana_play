#{extends 'main.html' /}
#{set title:'Depositar Sobre' /}
#{form @start(deposit), 'id' : 'mainForm', 'class' : "bbq" }
<section>
    <header></header>
    <a id="backButton" href="#" class="boton_top">â—„ &{ 'application.back' }</a>
    <article>
        <h1 class="depositar_sobre">&{ 'main_menu.envelope_deposit' }</h1>
        <div class="step" id="first" >
            <div class="contenido">
                <ul class="columns">
                    <li class="fixed column" style="width: 60%">
                        <div class="columna">
                            #{ if ( formData.showReference1 || formData.showReference2 ) }
                            <div class="mensaje"><span>&{ 'application.input_reference' }</span></div>
                            #{/if}

                            #{ if ( formData.showReference1 ) }
                            #{select 'formData.reference1.value', items: referenceCodes, valueProperty:'numericId', labelProperty:'description', value:formData.reference1.value, class : 'full_width' /}
                            #{ifError 'formData.reference1'}
                            <label for="formData.reference1.value" generated="true" class="error" style="display: inline; ">&{ 'validation.required' }</label>
                            #{/ifError}
                            #{/if}
                            #{error 'formData.reference1' /}

                            #{ if ( formData.showReference2 ) }
                            <input  autocomplete="off" name="formData.reference2" type="text" placeholder="&{ 'counting_page.reference2_title' }:" class="full_width" 
                                    /> 
                            <!--                                   value="#{if play.mode.isDev() }REFERENCE2 TESTVAL#{/if} "-->
                            #{ifError 'formData.reference2'}
                            <label for="formData.reference1.value" generated="true" class="error" style="display: inline; ">&{ 'validation.required.reference2' }</label>
                            #{/ifError}
                            #{/if}
                        </div>
                    </li>
                    <li class="fixed column" style="width: 40%">
                        #{ keyboard useHardwareKeyboard: useHardwareKeyboard /}
                    </li>
                </ul>
            </div>
        </div>
        <div class="step" id="second" style="display: none">
            <div class="contenido">
                <input  autocomplete="off" name="second_next" id="second_next" type="hidden" class="link" value="envelope_code">
                <div class="mensaje"><span>&{ 'envelope_deposit.select_contents' }</span></div>
                <ul class="on-2 columns">
                    <li class="column">
                        <div class="columna">
                            <a name="cash_link" id="cash_link" href="#" class="link boton naranja full_width">&{ 'envelope_deposit.cash' }</a>
                            <a name="documents_link" id="documents_link" href="#" class="boton naranja full_width">&{ 'envelope_deposit.documents' }</a>
                            <input  autocomplete="off" type="hidden" id="hasDocuments" name="formData.hasDocuments"
                                    value="#{if ( formData.hasDocuments ) }true#{/if}#{else}false#{/else}"/>
                            <a name="checks_link" id="checks_link" href="#" class="link boton naranja full_width">&{ 'envelope_deposit.checks' }</a>
                        </div>
                    </li>
                    <li class="column">
                        <div class="columna">
                            <a name="tickets_link" id="tickets_link" href="#" class="link boton naranja full_width">&{ 'envelope_deposit.tickets' }</a>
                            <a name="others_link" id="others_link" href="#" class="boton naranja full_width">&{ 'envelope_deposit.others' }</a>
                            <input  autocomplete="off" type="hidden" id="hasOthers" name="formData.hasOthers" 
                                    value="#{if ( formData.hasOthers ) }true#{/if}#{else}false#{/else}"
                                    />
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div id="cash" class="step amount_input" style="display: none">
            <div class="contenido">
                <input  autocomplete="off" name="cash_second" id="cash_second" type="hidden" class="link" value="second">
                <ul class="columns">
                    <li class="fixed column" style="width: 60%">
                        <div class="columna">
                            <div class="mensaje"><span>&{ 'application.choose_currency' }</span></div>
                            %{ val = null; if ( formData.cashData != null ) { val = formData.cashData.value } }%
                            #{select 'formData.cashData.value', items: currencies, valueProperty:'numericId', labelProperty:'textId', value:val, class : 'full_width' /}
                            &{ 'envelope_deposit.amount_to_confirm' }
                            &nbsp;&nbsp;
                            <input type="number" autocomplete="off" name="formData.cashData.amount" id="cashData" value="${formData?.cashData?.amount}" placeholder="&{ 'envelope_deposit.amount_to_confirm_title' }" class="full_width" />
                            #{ifError 'formData.cashData.amount'}
                            <label for="formData.cashData.amount" generated="true" class="error" style="display: inline; ">&{ 'validation.required.cashData_amount' }</label>
                            #{/ifError}
                        </div>
                    </li>
                    <li class="fixed column" style="width: 40%">
                        #{ keyboard useHardwareKeyboard: useHardwareKeyboard /}
                    </li>
                </ul>
            </div>
        </div>
        <div id="checks" class="step amount_input" style="display: none">
            <div class="contenido">
                <input  autocomplete="off" name="checks_second" id="checks_second" type="hidden" class="link" value="second">
                <ul class="columns">
                    <li class="fixed column" style="width: 60%">
                        <div class="columna">
                            <div class="mensaje"><span>&{ 'application.choose_currency' }</span></div>
                            %{ val = null; if ( formData.cashData != null ) { val = formData.cashData.value } }%
                            #{select 'formData.checkData.value', items: currencies, valueProperty:'numericId', labelProperty:'textId', value:val, class : 'full_width' /}
                            &{ 'envelope_deposit.amount_to_confirm' }
                            &nbsp;&nbsp;
                            <input type="number" autocomplete="off" name="formData.checkData.amount" id="checkData" value="${formData?.checkData?.amount}" placeholder="&{ 'envelope_deposit.amount_to_confirm_title' }" class="full_width" />
                            #{ifError 'formData.checkData.amount'}
                            <label for="formData.checkData.amount" generated="true" class="error" style="display: inline; ">&{ 'validation.required.checkData_amount' }</label>
                            #{/ifError}
                        </div>                    
                    </li>
                    <li class="fixed column" style="width: 40%">
                        #{ keyboard useHardwareKeyboard: useHardwareKeyboard /}
                    </li>
                </ul>
            </div>
        </div>
        <div id="tickets" class="step amount_input" style="display: none">
            <div class="contenido">
                <input  autocomplete="off" name="tickets_second" id="tickets_second" type="hidden" class="link" value="second">
                <ul class="columns">
                    <li class="fixed column" style="width: 60%">
                        <input  autocomplete="off" name="tickets_second" id="cash_second" type="hidden" class="link" value="second">
                        <div class="columna">
                            <div class="mensaje"><span>&{ 'application.choose_currency' }</span></div>
                            %{ val = null; if ( formData.cashData != null ) { val = formData.cashData.value } }%
                            #{select 'formData.ticketData.value', items: currencies, valueProperty:'numericId', labelProperty:'textId', value:val, class : 'full_width' /}
                            &{ 'envelope_deposit.amount_to_confirm' }
                            &nbsp;&nbsp;
                            <input type="number" autocomplete="off" name="formData.ticketData.amount" id="ticketData" value="${formData?.ticketData?.amount}" placeholder="&{ 'envelope_deposit.amount_to_confirm_title' }" class="full_width" />
                            #{ifError 'formData.ticketData.amount'}
                            <label for="formData.ticketData.amount" generated="true" class="error" style="display: inline; ">&{ 'validation.required.ticketData_amount' }</label>
                            #{/ifError}         
                        </div>
                    </li>
                    <li class="fixed column" style="width: 40%">
                        #{ keyboard useHardwareKeyboard: useHardwareKeyboard /}
                    </li>
                </ul>
            </div>
        </div>
        <div id="envelope_code" class="step submit_step" style="display: none">
            <div class="contenido">
                <input  autocomplete="off" name="envelope_code_next" id="envelope_code_next" type="hidden" class="link" value="print_ticket">
                <ul class="columns">
                    <li class="fixed column" style="width: 60%">
                        <div class="columna">
                            <div class="mensaje"><span>&{ 'envelope_deposit.envelope_code_title' }</span></div>
                            <input type="number" autocomplete="off" name="formData.envelopeCode" placeholder="&{ 'envelope_deposit.envelope_code_title' }" class="full_width" />
                            <!--                                   value="#{if play.mode.isDev() }ENVELOPE CODE TESTVAL#{/if} "-->
                            #{ifError 'formData.envelopeCode'}
                            <label for="formData.envelopeCode" generated="true" class="error" style="display: inline; ">&{ 'validation.required.envelopeCode' }</label>
                            #{/ifError}
                        </div>
                    </li>
                    <li class="fixed column" style="width: 40%">
                        <div id="keyboard_placeholder"></div>
                    </li>
                </ul>
            </div>
        </div>
        <hr />
        <div class="botonera">
            <ul class="on-2 columns">
                <li class="column">
                    <div class="columna">
                        <!-- link cancelar -->
                        <a href="@{ Application.index() }" class="boton full_width rojo">&{ 'application.cancel' }</a>
                        <!-- /link cancelar -->
                    </div>
                </li>
                <li class="column">
                    <div class="columna" >
                        <!-- link continuar -->
                        <input autocomplete="off" type="submit"  value="&{ 'application.continue' }" id ="continueButton" class="boton full_width naranja"/>
                    </div>
                </li>
            </ul>
        </div>
        <div id="alerta_validacion" class="alerta error" style="display: none;">
            <div id="alerta_titulo">&{ 'application.error' }</div>
            <div id="alerta_cuerpo">
                <div id="alerta_texto">
                    <div id="error_text">
                        <span id="validation_error"></span>
                        <span class="info_message" style="color: green;"></span>
                    </div>
                </div>
                <div id="alerta_botonera">
                    <a id="alerta_continueButton" class="boton naranja">&{ 'application.continue' }</a>
                </div>
            </div>
        </div>
    </article>
</section>
#{/form}


#{set 'moreScripts'}
#{script 'jquery/jquery.form.js' /}
#{script 'jquery/jquery.validate.js' /}
#{script 'jquery/bbq.js' /}
#{script 'jquery/jquery.form.wizard.js' /}
<script type="text/javascript" charset="${_response_encoding}">
    $(function(){
        $("#mainForm").formwizard({ 
            formPluginEnabled: false,
            validationEnabled: true,
            focusFirstInput : true,
            textSubmit: "&{ 'application.continue' }",
            textNext: "&{ 'application.continue' }",
            textBack: "&{ 'application.back' }",
            inAnimation : {height: 'none'},
            outAnimation: {height: 'none'},
            inDuration : 0,
            outDuration: 0,
            validationOptions : {
                rules: {
                    //'formData.reference2' : "required",
                    'formData.envelopeCode' : { required: true, range : [ 0,99999 ] },
                    'formData.cashData.amount' : "number",
                    'formData.checkData.amount' : "number",
                    'formData.ticketData.amount' : "number"
                },
                onkeyup: false,
                onclick: false,
                messages: {
                    //'formData.reference2': { required: "&{ 'validation.required' }", number: "&{ 'validation.must_be_a_number'} "},
                    'formData.envelopeCode': { required: "&{ 'validation.required' }", number: "&{ 'validation.must_be_a_number'}",  range: "&{ 'validation.must_be_a_5_number'}" },
                    'formData.cashData.amount': { required: "&{ 'validation.required' }", number: "&{ 'validation.must_be_a_number'} "},
                    'formData.checkData.amount': { required: "&{ 'validation.required' }", number: "&{ 'validation.must_be_a_number'} "},
                    'formData.ticketData.amount': { required: "&{ 'validation.required' }", number: "&{ 'validation.must_be_a_number'} "}
                },
                showErrors: function(errorMap, errorList) {
                    $( "#validation_error" ).html( "" );
                    $.each( errorMap, function( name, value ) {
                        $( 'input[ name="' + name + '"]' ).val( "" );
                        $( "#validation_error" ).html( $( "#validation_error" ).html() +  "<br/>" + value );
                    } );
                    if ( this.numberOfInvalids() > 0 ) {
                        $("#alerta_validacion").overlay().load();
                    }
                    this.defaultShowErrors();
                }
            }
        }
    );
          
        $( '#alerta_continueButton' ).click( function(event) {
            $( "#alerta_validacion" ).overlay().close();
            onError = false;
        });
        
      
        $("#mainForm").bind("step_shown", function(event, data) {
            Elastic.refresh();
            function checkAndSet( check, set ) {
                str = $( check ).val();
                if ( ! ( ! str ) && ! /^\s*$/.test( str ) && str > 0 ) {
                    $( set ).addClass( 'verde' ).removeClass( 'naranja');
                } else {
                    $( set ).addClass( 'naranja' ).removeClass( 'verde');
                }
            };
            
            if (data.currentStep == 'second') {
                checkAndSet( '#cashData' , '#cash_link' );
                checkAndSet( '#checkData' , '#checks_link' );
                checkAndSet( '#ticketData' , '#tickets_link' );
                if ( $( '#hasDocuments' ).val() == 'true' ) {
                    $( '#documents_link').addClass( 'verde' ).removeClass( 'naranja');
                }
                if ( $( '#hasOthers' ).val() == 'true' ) {
                    $( '#others_link').addClass( 'verde' ).removeClass( 'naranja');
                }
            } else if ( data.currentStep == 'envelope_code') {
                // last step activate all input, (hack).
                $(":input").not(".wizard-ignore").removeAttr("disabled")
            }
            
        });
        $( '#cash_link' ).click( function(event) {
            $("#mainForm").formwizard("show","cash");
        });
        $( '#checks_link' ).click( function(event) {
            $("#mainForm").formwizard("show","checks");
        });
        $( '#tickets_link' ).click( function(event) {
            $("#mainForm").formwizard("show","tickets");
        });
        $( '#documents_link' ).click( function(event) {
            if ( $("#hasDocuments").val() == 'true' ) {
                $("#hasDocuments").val("false");
                $( '#documents_link').addClass( 'naranja' ).removeClass( 'verde');
            } else {
                $("#hasDocuments").val("true");
                $( '#documents_link').addClass( 'verde' ).removeClass( 'naranja');

            }
        });
        $( '#others_link' ).click( function(event) {
            if ( $("#hasOthers").val() == 'true' ) {
                $("#hasOthers").val("false");
                $( '#others_link').addClass( 'naranja' ).removeClass( 'verde');
            } else {
                $("#hasOthers").val("true");
                $( '#others_link').addClass( 'verde' ).removeClass( 'naranja');
            }
        });
        $( '#backButton' ).click( function(event) {
            state = $("#mainForm").formwizard("state");
            if ( state.isFirstStep ) {
                window.location.href = "@{ Application.index() }";
            };
            $("#mainForm").formwizard("back");
        });
    });
    
</script>
#{/set}