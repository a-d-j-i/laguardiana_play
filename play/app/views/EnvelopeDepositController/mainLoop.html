#{extends 'main.html' /}
#{set title:'Contenido del sobre' /}
<section id="depositar_sobre_06">
    <header></header>
    <!-- link volver -->
    <!--    <a href="@{ finish() }" class="boton_top">â—„ &{ 'application.back' }</a>-->
    <article>
        <h1 class="depositar_sobre">&{ 'main_menu.envelope_deposit' }</h1>
        <div class="contenido">
            <div class="mensaje"><span>&{ 'envelope_deposit.put_ticket_in_envelope' }</span></div>
            <ul class="columns">
                <li class="column">
                    <p>&{ 'message.client_code_title' }: #{if play.configuration['style.useGecosAsClientCode']}${user.gecos}#{/if}#{else}${clientCode}#{/else}</p>
                    #{if ( showReference1 ) }
                    <p>&{ 'message.reference1_title' }: ${reference1.lov}</p>
                    #{/if}
                    #{if ( showReference2 && reference2 != "" ) }
                    <p>&{ 'message.reference2_title' }: ${reference2}</p>
                    #{/if}

                    #{list items:currentDeposit.envelopes, as:'env'}
                    #{list items:env.envelopeContents, as:'c'}
                    <p> 
                        #{if c.contentTypeLov == 1 && c.amount > 0 }
                        &{ 'envelope_deposit.amount_cash' } ${ c.amount } ${ c.currency.description } 
                        #{/if}
                        #{elseif c.contentTypeLov == 2 && c.amount > 0 }
                        &{ 'envelope_deposit.amount_checks' } ${ c.amount } ${ c.currency.description } 
                        #{/elseif}
                        #{elseif c.contentTypeLov == 3 && c.amount > 0 }
                        &{ 'envelope_deposit.amount_tickets' } ${ c.amount } ${ c.currency.description } 
                        #{/elseif}
                        #{elseif c.contentTypeLov == 4}
                        &{ 'envelope_deposit.has_documents' }
                        #{/elseif}
                        #{elseif c.contentTypeLov == 5}
                        &{ 'envelope_deposit.has_others' }
                        #{/elseif}
                        #{else}
                        #{/else}
                    </p>
                    #{/list}
                    <p>&{ 'envelope_deposit.envelope_code' }: ${ env.envelopeNumber }</p>
                    <p>&nbsp;</p>
                    #{/list}
                    <!-- /resumen de datos -->
                    <div class="info_message blink" style="color: green;"> 
                </li>
            </ul>
        </div>
        <hr>
        <div class="botonera">
            <ul class="on-2 unit">
                <li class="column">
                    <!-- link cancelar -->
                    <div class="columna">
                        <a href="#" class="cancelButton boton full_width rojo">&{ 'application.cancel' }</a>
                    </div>
                </li>
                <li class="column">
                    <div class="columna">
                        <!-- link continuar -->
                        #{if ( stateName == "READY_TO_STORE_SENSORLESS" ) }
                        <a id ="continueButton" href="#" class="continueButton boton full_width ${play.configuration['style.button_color']}">&{ 'application.continue' }</a>
                        #{/if}
                    </div>
                </li>
            </ul>
        </div>
    </article>
    <div id="main_overlay" class="alerta info" style="display: none;">
        <!--        <div id="overlay_contents"></div>-->
        <div id="alerta_cancel" class="alerta_info" style="display: none;">
            <div id="alerta_titulo">&{ 'application.canceling' }</div>
            <div id="alerta_cuerpo">
                <div id="alerta_texto">
                    <div id="error_text">
                        <span>&{ 'application.canceling_detail' }</span>
                        <span class="info_message" style="color: green;"></span>
                    </div>
                </div>
            </div>
        </div>
        <div id="alerta_storing" class="alerta_info" style="display: none;">
            <div id="alerta_titulo">&{ 'message.storing' }</div>
            <div id="alerta_cuerpo">
                <div id="alerta_texto">
                    <span id="error_text">&{ 'message.storing_detail' }</span>
                    <span class="info_message" style="color: green;"></span>
                </div>
            </div>
        </div>
        <div id="alerta_bag_removed" class="alerta_info" style="display: none;">
            <div id="alerta_titulo">&{ 'application.bag_not_in_place' }</div>
            <div id="alerta_cuerpo">
                <div id="alerta_texto">
                    <span id="error_text">&{ 'application.bag_not_in_place' }</span>
                </div>
                <div id="alerta_botonera">
                    <a href="#" id="alerta_bag_removed_cancel_btn" class="cancelButton boton rojo">&{ 'application.cancel' }</a>
                </div>
            </div>
        </div>
        <div id="alerta_remove_rejected_bills" class="alerta_info" style="display: none;">
            <div id="alerta_titulo">&{ 'message.remove_rejected_bills' }</div>
            <div id="alerta_cuerpo">
                <div id="alerta_texto">
                    <span id="error_text">&{ 'message.remove_rejected_bills' }</span>
                </div>
            </div>
        </div>
        <div id="alerta_jam" class="alerta_info" style="display: none;">
            <div id="alerta_titulo">&{ 'application.envelope_jam' }</div>
            <div id="alerta_cuerpo">
                <div id="alerta_texto">
                    <span id="error_text">&{ 'application.envelope_jam' }</span>
                </div>
            </div>
        </div>

    </div>
</section>


#{set 'moreScripts'}
<script src="@{'/public/javascripts/main_loop.js'}" type="text/javascript" charset="${_response_encoding}"></script>
<script type="text/javascript" charset="${_response_encoding}">

    doRefresh = function () {
        $.getJSON('@{mainLoop}', function (data) {
            var status = data[ 0 ];
            var billData = data[ 1 ];
            if (status != null && status.toString() != 'null') {
                $('.info_message').html(data[ 2 ]);

                if (status == 'TIMEOUT_WARNING') {
                    showAlert("#alerta_timeout");
                } else if (status == 'CANCELING') {
                    showAlert('#alerta_cancel');
                } else if (status == 'STORING') {
                    showAlert('#alerta_storing');
                } else if (status == 'REMOVE_REJECTED_BILLS') {
                    showAlert('#alerta_remove_rejected_bills');
                } else if (status == 'BAG_REMOVED') {
                    showAlert('#alerta_bag_removed');
                } else if (status == 'JAM') {
                    showAlert('#alerta_jam');
                } else {
                    closeAlert();
                    /*closeAlert( "#alerta_timeout" );
                     closeAlert( "#alerta_cancel" );
                     closeAlert( "#alerta_storing" );    
                     closeAlert( "#alerta_remove_rejected_bills" );    
                     closeAlert( "#alerta_bag_removed" );    */
                }

                if (status == 'IDLE' || status == 'JAM' || status == 'CANCELING' || status == 'STORING' || status == 'REMOVE_REJECTED_BILLS' || status == 'BAG_REMOVED') {
                } else if (status == 'FINISH') {
                    window.location.href = "@{finish}";
                    return;
                } else if (status == 'READY_TO_STORE') {
                    //                    $( '.continueButton' ).attr( { 'class' : 'boton ${play.configuration['style.button_color']}'});
                } else if (status == 'READY_TO_STORE_SENSORLESS') {
                    //  $( '.continueButton' ).attr( { 'class' : 'boton ${play.configuration['style.button_color']}'});
                } else if (status == 'ERROR') {
                    //window.location.href = "{counterError()}";
                } else {
                    alert("Invalid status : " + status + " last status : " + lastStatus);
                }
                lastStatus = status
            }
            doneRefresh();
        }).fail( function() { window.location.href = "@{Secure.login()}" } );
    };


    $('.continueButton').click(function (event) {
        if (!waiting) {
            $.getJSON('@{accept()}', function (data) {
            });
        }
    });

    $('.cancelButton').click(function (event) {
        if (!waiting) {
            $.getJSON('@{cancel()}', function (data) {
            });
        }
    });
</script>
#{/set}

